# 現状実装機能ドキュメント

## 1. プロジェクト概要

### 1.1 アプリケーション名
Tukuome 3rd (tukuome3v2)

### 1.2 目的
レシピ管理アプリケーション。クックパッドからレシピをスクレイピングして登録し、タグやフォルダーで整理・管理するためのWebアプリケーション。

### 1.3 主要な特徴
- クックパッドからのレシピ情報の自動取得（スクレイピング）
- 階層構造を持つタグシステムによる分類
- フォルダー機能によるレシピの整理
- 多様な検索・フィルタリング機能
- LLM連携による自動タグ付け
- 作者別のレシピ管理

---

## 2. 技術スタック

### 2.1 フロントエンド
- **フレームワーク**: Next.js 15.4.4 (App Router)
- **UIライブラリ**: React 19.1.0
- **スタイリング**: Tailwind CSS 4
- **UIコンポーネント**: Radix UI
- **アイコン**: Lucide React

### 2.2 バックエンド
- **ランタイム**: Node.js
- **データベース**: Vercel Postgres (PostgreSQL)
- **認証**: NextAuth.js 4.24.11
- **スクレイピング**: Cheerio 1.1.2

### 2.3 外部連携
- **LLM API**: カスタムエンドポイント (環境変数 `GEMMA_API_ENDPOINT`)

### 2.4 開発ツール
- **言語**: TypeScript 5
- **ビルドツール**: Turbopack
- **リンター**: ESLint

---

## 3. データベース構成

### 3.1 テーブル一覧

#### 3.1.1 repo (レシピテーブル)
レシピ情報を格納するメインテーブル。

**カラム:**
- `userid` (VARCHAR(2000), NOT NULL): ユーザーID（主キーの一部）
- `id_n` (INTEGER, NOT NULL): レシピID（主キーの一部）
- `image` (VARCHAR(2000)): レシピ画像URL
- `title` (VARCHAR(2000)): レシピタイトル
- `rank` (INTEGER): 評価状態（0: いいねなし, 1: 好き, 2: まあまあ, 9: 好きじゃない）
- `reposu_n` (INTEGER): つくれぽ数
- `comment` (VARCHAR(2000)): ユーザーコメント
- `tag` (VARCHAR(2000)): タグ（スペース区切り文字列）
- `ismain` (INTEGER): 主菜フラグ（1: 主菜, 0: その他, 9: 既読）
- `issub` (INTEGER): 副菜フラグ（1: 副菜, 0: その他）

**主キー**: (userid, id_n)

#### 3.1.2 tag (タグテーブル)
階層構造を持つタグ情報を格納するテーブル。

**カラム:**
- `userid` (VARCHAR(2000), NOT NULL): ユーザーID（主キーの一部）
- `id` (INTEGER, NOT NULL): タグID（主キーの一部）
- `level` (INTEGER): タグのレベル（0: 大タグ, 1: 中タグ, 2: 小タグ, 3: 極小タグ）
- `dispname` (VARCHAR(2000)): 表示用名称
- `name` (VARCHAR(2000)): タグの識別子（階層を連結した文字列）
- `l` (VARCHAR(255), DEFAULT ''): 大タグ
- `m` (VARCHAR(255), DEFAULT ''): 中タグ
- `s` (VARCHAR(255), DEFAULT ''): 小タグ
- `ss` (VARCHAR(255), DEFAULT ''): 極小タグ

**主キー**: (userid, id)

#### 3.1.3 folder (フォルダーテーブル)
レシピを整理するためのフォルダー情報を格納するテーブル。

**カラム:**
- `userid` (VARCHAR(2000)): ユーザーID
- `foldername` (VARCHAR(2000)): フォルダー名
- `idofrepos` (VARCHAR(2000)): フォルダーに含まれるレシピID（スペース区切り文字列）

**主キー**: (userid, foldername)（推測）

#### 3.1.4 mastertag (マスタータグテーブル)
タグのマスターデータを格納するテーブル。世代管理に対応。

**カラム:**
- `userid` (VARCHAR(2000)): ユーザーID（主キーの一部）
- `gen` (INTEGER): 世代（0: 前世代, 1: 現世代）（主キーの一部）
- `id` (INTEGER): タグID（主キーの一部）
- `l` (VARCHAR(2000)): 大タグ
- `m` (VARCHAR(2000)): 中タグ
- `s` (VARCHAR(2000)): 小タグ
- `ss` (VARCHAR(2000)): 極小タグ

**主キー**: (userid, gen, id)

### 3.2 データモデル

#### 3.2.1 レシピデータモデル
```typescript
type Repo = {
  userid: string;
  id_n: number;
  image: string;
  title: string;
  rank: number;        // 0: いいねなし, 1: 好き, 2: まあまあ, 9: 好きじゃない
  reposu_n: number;     // つくれぽ数
  comment: string;      // ユーザーコメント
  tags: string[];       // タグ配列（DBではスペース区切り文字列）
  ismain: number;       // 1: 主菜, 0: その他, 9: 既読
  issub: number;        // 1: 副菜, 0: その他
  foldered?: boolean;   // フォルダーに登録済みかどうか
  author?: string;      // 作者名
}
```

#### 3.2.2 タグデータモデル
```typescript
type Tag = {
  id: number;
  level: number;       // 0: 大タグ, 1: 中タグ, 2: 小タグ, 3: 極小タグ
  dispname: string;    // 表示用名称
  name: string;        // 識別子（階層を連結）
  l: string;           // 大タグ
  m: string;           // 中タグ
  s: string;           // 小タグ
  ss: string;          // 極小タグ
}
```

---

## 4. 認証・セッション管理

### 4.1 認証方式
- **認証プロバイダー**: NextAuth.js (Credentials Provider)
- **認証方法**: ユーザー名のみ（パスワードなし）
- **セッション管理**: NextAuth.jsのデフォルトセッション管理

### 4.2 認証可能なユーザー
現在はハードコードされたユーザーリストを使用：
- sahamaru
- tonkati
- sasaking
- sara
- sysop

### 4.3 認証フロー
1. ログインページ (`/login`) でユーザー名を入力
2. NextAuth.jsのCredentials Providerで認証
3. 認証成功後、セッションが作成され `/recipes` にリダイレクト
4. 未認証の場合は `/login` にリダイレクト

### 4.4 セッション情報
- セッションから `session.user.name` を取得してユーザーIDとして使用
- すべてのデータ操作はユーザーIDでフィルタリング

---

## 5. 主要機能一覧

### 5.1 レシピ管理機能

#### 5.1.1 レシピ一覧表示 (`/recipes`)
- **機能**: レシピの一覧を表示
- **表示形式**: グリッドレイアウト（1ページあたり12件）
- **ページネーション**: 無限スクロール（Load More方式）
- **表示項目**: 画像、タイトル、つくれぽ数、いいね状態、フォルダー登録状態

#### 5.1.2 レシピ追加 (`/recipes/new`)
- **機能**: 新しいレシピを追加
- **入力方法**:
  - レシピID（数値）を直接入力
  - クックパッドのURLから自動取得（スクレイピング）
- **自動取得情報**:
  - タイトル
  - 画像URL
  - つくれぽ数
  - 作者名
  - レシピID
  - 材料リスト
- **LLM連携**: タイトルと材料から自動でタグ付け（主菜/副菜分類、素材別タグ、カテゴリタグ）
- **手動設定項目**:
  - 主菜/副菜フラグ
  - タグ選択（素材別タグ、カテゴリタグ）

#### 5.1.3 レシピ編集 (`/recipes/edit?id={recipeId}`)
- **機能**: 既存レシピの情報を編集
- **編集可能項目**:
  - タイトル
  - 画像URL
  - つくれぽ数
  - 主菜/副菜フラグ
  - タグ
- **再スクレイピング**: レシピIDから最新情報を再取得可能

#### 5.1.4 レシピ削除
- **機能**: レシピをデータベースから削除
- **実装**: サーバーアクション経由

#### 5.1.5 レシピ詳細操作
- **いいね機能**: レシピの評価を設定（rank: 0: いいねなし, 1: 好き, 2: まあまあ, 9: 好きじゃない）
- **コメント機能**: レシピにコメントを追加・編集
- **フォルダー登録**: レシピをフォルダーに追加/削除

### 5.2 検索・フィルタリング機能

#### 5.2.1 検索方法
- **タイトル検索**: タイトルに含まれる文字列で検索
- **レシピID検索**: 数値のみの入力でレシピID検索
- **タグ検索**: 特定のタグが付いたレシピを検索
- **フォルダー検索**: 特定のフォルダーに含まれるレシピを検索
- **作者検索**: 作者名で検索（作者一覧ページから）

#### 5.2.2 フィルタリング
- **分類フィルタ**:
  - すべて
  - 主菜のみ
  - 副菜のみ
  - その他
- **いいねフィルタ**:
  - すべて
  - 好き（rank = 1）
  - まあまあ（rank = 2）
  - 注: 好きじゃない（rank = 9）はフィルタ対象外（ユーザーがもう作りたくないという目印として使用）
- **タグフィルタ**:
  - すべて
  - タグ未設定のみ（untagged）
- **ソート**:
  - つくれぽ数降順（デフォルト）
  - つくれぽ数昇順
  - レシピID降順

#### 5.2.3 検索パラメータ
URLクエリパラメータで検索条件を保持：
- `title`: 検索文字列
- `mode`: 分類フィルタ（all, main_dish, sub_dish, others）
- `tag`: タグ名
- `folder`: フォルダー名
- `rank`: いいねフィルタ（all, 1, 2）※9（好きじゃない）はフィルタ対象外
- `sort`: ソート順（asc, desc）
- `tagmode`: タグフィルタ（untaged）

### 5.3 タグ管理機能

#### 5.3.1 タグ検索 (`/recipes/tags`)
- **機能**: 階層構造を持つタグからレシピを検索
- **表示形式**: タグカード（画像、表示名、子タグ数/レシピ数）
- **階層ナビゲーション**: 大タグ → 中タグ → 小タグ → 極小タグ
- **タグ選択**: タグをクリックしてレシピ一覧に遷移

#### 5.3.2 タグメンテナンス (`/recipes/tags/maintenance`)
- **機能**: タグのマスターデータを管理
- **入力形式**: タブ区切りテキスト（l, m, s, ss）
- **世代管理**: 前世代（gen=0）と現世代（gen=1）を保持
- **更新処理**:
  1. マスタータグテーブル（gen=1）を更新
  2. タグテーブルを再構築（階層構造を自動生成）

#### 5.3.3 タグの階層構造
- **レベル0（大タグ）**: 例: "おかず"
- **レベル1（中タグ）**: 例: "おかず肉" → 表示名は "肉"
- **レベル2（小タグ）**: 例: "おかず肉牛肉" → 表示名は "牛肉"
- **レベル3（極小タグ）**: 例: "おかず肉牛肉ステーキ" → 表示名は "ステーキ"

#### 5.3.4 タグの自動付与
- **LLM連携**: レシピ追加時にLLM APIを呼び出し
- **分類**: 主菜/副菜/その他を自動判定
- **素材別タグ**: 主材料から "素材別{材料名}" タグを自動生成
- **カテゴリタグ**: 料理カテゴリから "料理{カテゴリ名}" タグを自動生成

### 5.4 フォルダー管理機能

#### 5.4.1 フォルダー一覧 (`/recipes/folders`)
- **機能**: 作成済みフォルダーの一覧を表示
- **表示形式**: グリッドレイアウト（フォルダー名、サムネイル画像4枚）
- **フォルダー選択**: クリックでフォルダー内のレシピ一覧に遷移

#### 5.4.2 フォルダー操作
- **フォルダー作成**: 新しいフォルダーを作成
- **フォルダー削除**: フォルダーを削除
- **レシピ追加**: レシピをフォルダーに追加
- **レシピ削除**: フォルダーからレシピを削除
- **フォルダー選択ダイアログ**: レシピ詳細からフォルダー操作

### 5.5 作者管理機能

#### 5.5.1 作者一覧 (`/recipes/Authers`)
- **機能**: 登録されているレシピの作者一覧を表示
- **表示項目**: 作者名、レシピ数、代表画像
- **ページネーション**: 無限スクロール（Load More方式）
- **作者選択**: クリックでその作者のレシピ一覧に遷移

#### 5.5.2 作者情報の取得
- **スクレイピング**: クックパッドのレシピページから作者名を抽出
- **集計**: 同一作者のレシピ数を集計
- **代表画像**: その作者のレシピで最もつくれぽ数の多いレシピの画像を使用

### 5.6 スクレイピング機能

#### 5.6.1 スクレイピング対象
クックパッドのレシピページ（`https://cookpad.com/recipe/{recipeId}`）

#### 5.6.2 取得情報
- **タイトル**: `#header--recipe-title` から取得
- **つくれぽ数**: `data-cooksnapped-count-cooksnaps-count-value` 属性から取得
- **画像**: `<picture>` タグ内の `<img>` の `src` 属性から取得
- **作者名**: 
  - ユーザー画像の `title` 属性
  - または `div.max-lg:hidden.print:block` 内の `span.font-semibold` から取得
- **レシピID**: レシピID表示ボタンから取得
- **材料リスト**: `li.justified-quantity-and-name` から取得

#### 5.6.3 実装
- **ライブラリ**: Cheerio
- **処理**: HTMLをパースしてDOMから情報を抽出
- **シリアライズ**: DOMをシリアライズ可能なオブジェクトに変換

### 5.7 LLM連携機能

#### 5.7.1 LLM API
- **エンドポイント**: 環境変数 `GEMMA_API_ENDPOINT`（デフォルト: `http://tukuomeko:8000/generate`）
- **リクエスト形式**: JSON（`{ prompt: string }`）
- **レスポンス形式**: JSON（`{ response: LlmResponse | string }`）

#### 5.7.2 LLMへの入力
- **タイトル**: レシピのタイトル
- **材料リスト**: レシピの材料リスト

#### 5.7.3 LLMからの出力
```typescript
interface LlmResponse {
  "レシピ分類": "主菜" | "副菜" | "その他";
  "主材料": string[];
  "カテゴリ": string;
}
```

#### 5.7.4 出力の変換
- **レシピ分類**: `ismain` / `issub` フラグに変換
- **主材料**: `素材別{材料名}` タグに変換
- **カテゴリ**: `料理{カテゴリ名}` タグに変換

#### 5.7.5 エラーハンドリング
- LLM API呼び出し失敗時はデフォルト値（"その他"分類、空のタグ）を返す

---

## 6. API/サーバーアクション一覧

### 6.1 レシピ関連

#### 6.1.1 レシピ取得
- `getRecipes(offset, limit, mode, rank, sort, tagMode)`: レシピ一覧を取得
- `getRecipesByTitle(searchTerm, offset, limit, mode, rank, sort, tagMode)`: タイトルで検索
- `getRecipesByTag(tagName, offset, limit, mode, rank, sort, tagMode)`: タグで検索
- `getRecipesByFolder(folderName, offset, limit, mode, rank, sort, tagMode)`: フォルダーで検索
- `getRecipeById(recipeId)`: レシピIDで検索
- `getFilteredRecipes(offset, limit, searchTerm?, searchMode?, searchTag?, folderName?, searchRank?, searchSort?, tagMode?)`: 統合検索

#### 6.1.2 レシピ操作
- `addRecipe(recipeData)`: レシピを追加
- `updateRecipe(recipeData)`: レシピを更新
- `deleteRecipe(id_n)`: レシピを削除
- `setLike(recipeId, newRank)`: いいね状態を更新
- `addComment(recipeId, comment)`: コメントを追加

### 6.2 タグ関連

#### 6.2.1 タグ取得
- `getDispTags(level, value)`: 表示用タグを取得（階層ナビゲーション用）
- `getTagsByName(pattern)`: パターンでタグを検索

#### 6.2.2 タグ操作
- `updateTags(tags)`: タグテーブルを更新
- `updateMasterTagsInDb(masterTagText)`: マスタータグを更新（タブ区切りテキストから）
- `loadMasterTagsFromDb(gen)`: マスタータグを取得（タブ区切りテキスト形式で）

### 6.3 フォルダー関連

#### 6.3.1 フォルダー取得
- `fetchFolders(recipeId)`: フォルダー一覧を取得（レシピの登録状態付き）
- `fetchFoldersWithImages()`: フォルダー一覧を取得（サムネイル画像付き）

#### 6.3.2 フォルダー操作
- `createFolder(folderName)`: フォルダーを作成
- `removeFolder(folderName)`: フォルダーを削除
- `addRecipeToFolderAction(folderName, recipeId)`: レシピをフォルダーに追加
- `removeRecipeFromFolderAction(folderName, recipeId)`: フォルダーからレシピを削除

### 6.4 作者関連

#### 6.4.1 作者取得
- `fetchAuthers(offset, limit)`: 作者一覧を取得

### 6.5 スクレイピング関連

#### 6.5.1 スクレイピング
- `scrapeUrl(url)`: URLからレシピ情報を取得
  - 戻り値: `{ dom: SerializableNode, recipeInfo: RecipeInfo }`

### 6.6 LLM関連

#### 6.6.1 LLM連携
- `getTagsFromLlm(title, ingredients)`: LLMからタグ情報を取得
  - 戻り値: `{ isMain: boolean, isSub: boolean, tags: string[] }`

---

## 7. UI/UX機能

### 7.1 レイアウト

#### 7.1.1 ナビゲーションバー
- **固定ヘッダー**: 画面上部に固定表示
- **ロゴ**: アプリケーションロゴ
- **ユーザー名表示**: セッションから取得したユーザー名を表示
- **メニュー項目**:
  - レシピ追加
  - タグ検索
  - フォルダ
  - 作者一覧
  - タグメンテ
  - ログアウト
- **レスポンシブ**: モバイルではハンバーガーメニュー

#### 7.1.2 フィルターコントロール
- **検索バー**: タイトル検索
- **分類メニュー**: すべて/主菜/副菜/その他
- **いいねフィルター**: すべて/好き/まあまあ（好きじゃないはフィルタ対象外）
- **タグフィルター**: すべて/タグ未設定
- **ソートメニュー**: つくれぽ数（昇順/降順）

### 7.2 コンポーネント

#### 7.2.1 レシピカード
- **表示項目**: 画像、タイトル、つくれぽ数、いいねボタン、フォルダーボタン
- **操作**: クリックで編集ページに遷移

#### 7.2.2 レシピフォーム
- **入力項目**:
  - レシピID/URL
  - タイトル
  - 画像URL
  - つくれぽ数
  - 主菜/副菜チェックボックス
  - タグ選択（素材別、カテゴリ）
- **操作ボタン**:
  - 取得（スクレイピング）
  - 保存
  - 削除（編集モード時）
  - キャンセル

#### 7.2.3 タグカード
- **表示項目**: タグ画像、表示名、子タグ数/レシピ数
- **操作**: クリックで階層ナビゲーションまたはレシピ検索

#### 7.2.4 フォルダーダイアログ
- **機能**: レシピをフォルダーに追加/削除
- **表示**: フォルダー一覧（チェックボックス付き）

### 7.3 ページネーション

#### 7.3.1 無限スクロール
- **方式**: Load Moreボタン
- **初期表示**: 12件
- **追加読み込み**: 12件ずつ

### 7.4 レスポンシブデザイン
- **モバイル**: ハンバーガーメニュー、グリッドレイアウト調整
- **デスクトップ**: フルメニュー表示、多カラムレイアウト

---

## 8. データフロー

### 8.1 レシピ追加フロー

1. ユーザーがレシピIDまたはURLを入力
2. 「取得」ボタンをクリック
3. サーバーアクションでスクレイピング実行
4. レシピ情報を取得（タイトル、画像、つくれぽ数、作者、材料）
5. LLM APIを呼び出してタグ情報を取得
6. フォームに情報を自動入力
7. ユーザーがタグを調整（オプション）
8. 「保存」ボタンをクリック
9. データベースにレシピを保存
10. レシピ一覧ページにリダイレクト

### 8.2 レシピ検索フロー

1. ユーザーが検索条件を設定（タイトル、分類、タグ、フォルダー、いいね、ソート）
2. URLクエリパラメータに反映
3. サーバーサイドでデータベースクエリ実行
4. レシピ一覧を取得（ページネーション対応）
5. クライアントサイドで表示
6. 「もっと見る」ボタンで追加読み込み

### 8.3 タグ管理フロー

1. タグメンテナンスページでタブ区切りテキストを編集
2. 「保存」ボタンをクリック
3. サーバーアクションでマスタータグテーブルを更新
4. タグテーブルを再構築（階層構造を自動生成）
5. タグ検索ページで反映

---

## 9. 環境変数

### 9.1 必須環境変数
- `POSTGRES_URL`: Vercel Postgresの接続URL
- `POSTGRES_PRISMA_URL`: Prisma用の接続URL（使用していない可能性あり）
- `POSTGRES_URL_NON_POOLING`: 非プーリング接続URL（使用していない可能性あり）
- `NEXTAUTH_SECRET`: NextAuth.jsのシークレットキー
- `NEXTAUTH_URL`: NextAuth.jsのベースURL

### 9.2 オプション環境変数
- `GEMMA_API_ENDPOINT`: LLM APIのエンドポイント（デフォルト: `http://tukuomeko:8000/generate`）

---

## 10. セキュリティ

### 10.1 認証
- すべてのページでセッション確認
- 未認証ユーザーは `/login` にリダイレクト

### 10.2 データ分離
- すべてのデータ操作でユーザーIDでフィルタリング
- 他ユーザーのデータにアクセス不可

### 10.3 SQLインジェクション対策
- パラメータ化クエリを使用（`@vercel/postgres`）

---

## 11. パフォーマンス

### 11.1 データベースクエリ
- ページネーション対応（LIMIT/OFFSET）
- インデックス活用（主キー、ユニークインデックス）
- バルクINSERT対応（タグ、マスタータグ）

### 11.2 フロントエンド
- サーバーサイドレンダリング（SSR）
- 無限スクロールによる段階的読み込み
- 画像最適化（Next.js Imageコンポーネント）

---

## 12. 今後の改善点（既知の課題）

### 12.1 データベース設計
- タグのスペース区切り文字列を正規化（多対多リレーション）
- フォルダーのスペース区切り文字列を正規化（多対多リレーション）
- インデックスの最適化

### 12.2 認証
- パスワード認証の実装
- データベースベースのユーザー管理

### 12.3 API設計
- RESTful APIへの移行検討
- APIルートの整理

### 12.4 エラーハンドリング
- エラーメッセージの統一
- エラーログの記録

---

## 13. 用語集

- **つくれぽ**: クックパッドの「つくれぽ」機能（レシピを作った人の投稿数）
- **いいね**: ユーザーがレシピに付ける評価（rank: 0=いいねなし, 1=好き, 2=まあまあ, 9=好きじゃない）
- **主菜**: メインディッシュ（ismain=1）
- **副菜**: サイドディッシュ（issub=1）
- **既読**: レシピを確認済み（ismain=9）
- **タグ**: レシピを分類するためのラベル（階層構造を持つ）
- **フォルダー**: レシピを整理するためのグループ
- **作者**: クックパッドのレシピ投稿者

---

## 14. 更新履歴

- 2024-XX-XX: 初版作成

---

## 15. 参考資料

- [Next.js Documentation](https://nextjs.org/docs)
- [NextAuth.js Documentation](https://next-auth.js.org/)
- [Vercel Postgres Documentation](https://vercel.com/docs/storage/vercel-postgres)
- [Cheerio Documentation](https://cheerio.js.org/)

