name: Gemini Issue Processor

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'The number of the issue to process'
        required: true

permissions:
  issues: write

jobs:
  process-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue data
        id: get_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.issue_number }}
            });
            return { title: issue.data.title, body: issue.data.body };
          result-encoding: json

      - name: Run Gemini CLI to process issue
        id: gemini_process
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ã‚ãªãŸã¯å„ªç§€ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚
            ä»¥ä¸‹ã®GitHub issueã®å†…å®¹ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

            1.  ã¾ãšissueã®å†…å®¹ã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚
            2.  æ¬¡ã«ã“ã®issueã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«å¿…è¦ãªå…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ã‚’ç®‡æ¡æ›¸ãã§ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚

            ---
            **Issue Title: ${{ fromJson(steps.get_issue.outputs.result).title }}**
            **Issue Body:**
            ${{ fromJson(steps.get_issue.outputs.result).body }}

      - name: Comment on issue with Gemini's output
        uses: actions/github-script@v7
        env:
          GEMINI_RESPONSE: ${{ steps.gemini_process.outputs.prompt-response }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `ğŸ¤– Geminiã«ã‚ˆã‚‹åˆ†æçµæœã§ã™ï¼š\n\n${process.env.GEMINI_RESPONSE}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.issue_number }},
              body: body
            });
